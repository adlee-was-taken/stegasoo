version: '3.8'

# Shared environment variables
x-common-env: &common-env
  STEGASOO_CHANNEL_KEY: ${STEGASOO_CHANNEL_KEY:-}

services:
  # ============================================================================
  # Web UI (Flask)
  # ============================================================================
  web:
    build:
      context: .
      target: web
    container_name: stegasoo-web
    ports:
      - "5000:5000"
    environment:
      <<: *common-env
      FLASK_ENV: production
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M

  # ============================================================================
  # REST API (FastAPI)
  # ============================================================================
  api:
    build:
      context: .
      target: api
    container_name: stegasoo-api
    ports:
      - "8000:8000"
    environment:
      <<: *common-env
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
