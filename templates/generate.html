{% extends "base.html" %}

{% block title %}Generate Phrase Card - Stegasoo{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key-fill me-2"></i>Generate Phrase Card + PIN</h5>
            </div>
            <div class="card-body">
                {% if not generated %}
                <p class="text-muted mb-4">
                    Generate your weekly phrase card and static PIN. Customize your security level:
                </p>
                
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Words per phrase</label>
                            <select name="words_per_phrase" class="form-select" id="wordsSelect">
                                <option value="3" selected>3 words (~33 bits)</option>
                                <option value="4">4 words (~44 bits)</option>
                                <option value="5">5 words (~55 bits)</option>
                                <option value="6">6 words (~66 bits)</option>
                                <option value="7">7 words (~77 bits)</option>
                                <option value="8">8 words (~88 bits)</option>
                                <option value="9">9 words (~99 bits)</option>
                                <option value="10">10 words (~110 bits)</option>
                                <option value="11">11 words (~121 bits)</option>
                                <option value="12">12 words (~132 bits)</option>
                            </select>
                            <div class="form-text">More words = more security, harder to memorize</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">PIN length</label>
                            <select name="pin_length" class="form-select" id="pinSelect">
                                <option value="6" selected>6 digits (~20 bits)</option>
                                <option value="7">7 digits (~23 bits)</option>
                                <option value="8">8 digits (~27 bits)</option>
                            </select>
                            <div class="form-text">Same PIN used every day</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-calculator me-2"></i>Estimated phrase+PIN entropy:</span>
                            <strong id="entropyDisplay">~53 bits</strong>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="entropyBar" style="width: 40%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            <span id="entropyDesc">Good for most use cases</span>
                            â€¢ Reference photo adds ~80-256 bits more
                        </small>
                    </div>
                    
                    <!--<div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" name="generate_stories" id="generateStories" checked>
                        <label class="form-check-label" for="generateStories">
                            <i class="bi bi-book me-2"></i>Generate memory aid stories
                            {% if has_ml %}<span class="badge bg-success ms-2">AI-powered</span>{% else %}<span class="badge bg-secondary ms-2">Template-based</span>{% endif %}
                        </label>
                        <div class="form-text">Creates memorable stories to help you remember each day's phrase</div>
                    </div>-->
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100" id="generateBtn">
                        <i class="bi bi-shuffle me-2"></i>Generate New Credentials
                    </button>
                </form>
                {% else %}
                
                <div class="alert alert-info">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Credentials Generated!</strong> - Refresh to generate new credentials
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Memorize the information then close!</strong> - Do not save/screenshot
                </div>
                
                <hr class="my-4">

                <div class="text-center mb-4">
                    <h6 class="text-muted mb-2">YOUR STATIC PIN</h6>
                    <div class="pin-container">
                        <div class="pin-display">{{ pin }}</div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Use this {{ pin_length }}-digit PIN every day</small>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h6 class="text-muted mb-3">DAILY PHRASES ({{ words_per_phrase }} words each)</h6>
                
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th style="width: 140px;">Day</th>
                                <th>Phrase</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                            <tr>
                                <td class="text-nowrap">
                                    <i class="bi bi-calendar3 me-2"></i>{{ day }}
                                </td>
                                <td>
                                    <span class="phrase-display">{{ phrases[day] }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-success mt-4">
                    <h6><i class="bi bi-shield-check me-2"></i>Security Summary</h6>
                    <div class="row text-center mt-3">
                        <div class="col-4">
                            <div class="fs-4 fw-bold">{{ phrase_entropy }}</div>
                            <small class="text-muted">bits/phrase</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold">{{ pin_entropy }}</div>
                            <small class="text-muted">bits/PIN</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold text-success">{{ total_entropy }}</div>
                            <small class="text-muted">bits total</small>
                        </div>
                    </div>
                    <small class="d-block mt-2 text-center text-muted">
                        + reference photo (~80-256 bits) = <strong>{{ total_entropy + 80 }}+ bits combined</strong>
                    </small>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="bi bi-lightbulb me-2"></i>Memorization Tip</h6>
                    <p class="mb-1">
                        <strong>Total to memorize:</strong> {{ words_per_phrase * 7 }} words + {{ pin_length }} digits
                    </p>
                    <p class="mb-0 small">
                        Create a story for each day: "On Monday, the <em>[word1]</em> and <em>[word2]</em> went to see <em>[word3]</em>..."
                    </p>
                </div>
                
                {% if stories %}
                <hr class="my-4">
                
                <h6 class="text-muted mb-3">
                    <i class="bi bi-book me-2"></i>MEMORY AID STORIES
                    {% if has_ml %}<span class="badge bg-success ms-2">AI-generated</span>{% else %}<span class="badge bg-secondary ms-2">Template-based</span>{% endif %}
                </h6>
                <p class="text-muted small mb-3">
                    Passphrase words are shown in <span class="story-word">RED CAPS</span>. 
                    Read each story to help memorize your phrases.
                </p>
                
                {% for day in days %}
                <div class="story-card">
                    <div class="day-label"><i class="bi bi-calendar3 me-2"></i>{{ day }}</div>
                    <div>{{ stories[day].story_html|safe }}</div>
                </div>
                {% endfor %}
                {% endif %}
                
                <a href="/generate" class="btn btn-outline-light btn-lg w-100 mt-3">
                    <i class="bi bi-arrow-repeat me-2"></i>Generate New Credentials
                </a>
                
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if not generated %}
<script>
function updateEntropy() {
    const words = parseInt(document.getElementById('wordsSelect').value);
    const pinLen = parseInt(document.getElementById('pinSelect').value);
    
    const phraseEntropy = words * 11;
    const pinEntropy = Math.floor(pinLen * 3.32);
    const total = phraseEntropy + pinEntropy;
    
    document.getElementById('entropyDisplay').textContent = '~' + total + ' bits';
    
    // Update progress bar (scale: 50 bits = 40%, 150 bits = 100%)
    const pct = Math.min(100, Math.max(10, (total - 30) * 0.7));
    document.getElementById('entropyBar').style.width = pct + '%';
    
    // Update description
    let desc;
    if (total < 50) desc = 'Basic security';
    else if (total < 70) desc = 'Good for most use cases';
    else if (total < 100) desc = 'Strong security';
    else if (total < 130) desc = 'Very strong security';
    else desc = 'Extreme security (hard to memorize!)';
    
    document.getElementById('entropyDesc').textContent = desc;
}

document.getElementById('wordsSelect').addEventListener('change', updateEntropy);
document.getElementById('pinSelect').addEventListener('change', updateEntropy);

// Loading state for generate button
document.querySelector('form').addEventListener('submit', function() {
    const btn = document.getElementById('generateBtn');
    const storiesChecked = document.getElementById('generateStories')?.checked;
    btn.disabled = true;
    if (storiesChecked) {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating stories...';
    } else {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    }
});
</script>
{% endif %}
{% endblock %}
